name: Weekly Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true
          
      - name: Check for high severity vulnerabilities
        run: |
          HIGH_VULNS=$(npm audit --audit-level=high --json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --audit-level=critical --json | jq '.metadata.vulnerabilities.critical // 0')
          
          if [ $HIGH_VULNS -gt 0 ] || [ $CRITICAL_VULNS -gt 0 ]; then
            echo "::error::Found $HIGH_VULNS high and $CRITICAL_VULNS critical vulnerabilities"
            npm audit --audit-level=high
            exit 1
          fi
          
      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        
      - name: Check for secrets in code
        run: |
          # APIキーやトークンのハードコードをチェック
          if grep -r "sk-[a-zA-Z0-9]\{48\}" src/ --include="*.ts" --include="*.tsx"; then
            echo "::error::Potential OpenAI API key found in source code"
            exit 1
          fi
          
          if grep -r "ya29\.[a-zA-Z0-9_-]\{68\}" src/ --include="*.ts" --include="*.tsx"; then
            echo "::error::Potential Google OAuth token found in source code"
            exit 1
          fi
          
          if grep -r "ghp_[a-zA-Z0-9]\{36\}" src/ --include="*.ts" --include="*.tsx"; then
            echo "::error::Potential GitHub token found in source code"
            exit 1
          fi
          
      - name: Check environment variable usage
        run: |
          # .envファイルの適切な使用をチェック
          if find . -name ".env*" -not -name ".env.example" -not -name ".env.local.example"; then
            echo "::warning::.env files found. Make sure they are not committed to repository."
          fi
          
      - name: Dependency license check
        run: |
          npx license-checker --summary
        continue-on-error: true